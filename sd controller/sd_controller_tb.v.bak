//=========================================================
// Testbench for SD_Controller - Integration Test
// - Mocks SD card responses for init/read/write.
// - Self-checking: Assert init_complete=1, data_valid=1 w/expected data,
//   write_complete=1, no error.
// - Logs key events.
//=========================================================
`timescale 1ns / 1ps

module sd_controller_tb;

    // TB signals (50MHz clk)
    reg clk;
    reg rst_n;
    reg read_next_block;
    reg write_enable;
    reg [31:0] write_addr;
    reg [511:0] write_data;
    wire spi_cs_n;
    wire spi_clk;
    wire spi_mosi;
    wire spi_miso;  // From mock
    wire init_complete;
    wire busy;
    wire error;
    wire [511:0] read_data;
    wire data_valid;
    wire write_complete;
    wire [31:0] current_block_addr;
    wire [7:0] sd_card_type;

    // DUT: Top module
    SD_Controller_Top dut (
        .clk(clk),
        .rst_n(rst_n),
        .spi_cs_n(spi_cs_n),
        .spi_clk(spi_clk),
        .spi_mosi(spi_mosi),
        .spi_miso(spi_miso),
        .read_next_block(read_next_block),
        .write_enable(write_enable),
        .write_addr(write_addr),
        .write_data(write_data),
        .init_complete(init_complete),
        .busy(busy),
        .error(error),
        .read_data(read_data),
        .data_valid(data_valid),
        .write_complete(write_complete),
        .current_block_addr(current_block_addr),
        .sd_card_type(sd_card_type)
    );

    // SD Mock instantiation (connects to SPI lines)
    sd_mock mock (
        .spi_clk(spi_clk),
        .spi_cs_n(spi_cs_n),
        .spi_mosi(spi_mosi),
        .spi_miso(spi_miso)
    );

    // Clk gen
    always #10 clk = ~clk;

    // Test sequence
    initial begin
        // Init
        clk = 0;
        rst_n = 0;
        read_next_block = 0;
        write_enable = 0;
        write_addr = 0;
        write_data = 512'hDEADBEEF;  // Test pattern for write

        #100;
        rst_n = 1;

        // Phase 1: Auto-init (wait for complete)
        $display("[%t] Starting auto-init...", $time);
        wait(init_complete == 1);
        $display("[%t] Init complete! Type=0x%h", $time, sd_card_type);
        assert (init_complete == 1) else $error("Init failed");
        assert (error == 0) else $error("Init error");

        // Phase 2: Read block 0
        #1000;  // Settle
        read_next_block = 1;
        #20 read_next_block = 0;
        wait(data_valid == 1);
        $display("[%t] Read complete: Addr=0x%h, Data[0:7]=0x%h", $time, current_block_addr, read_data[7:0]);
        assert (data_valid == 1) else $error("Read data_valid not set");
        assert (read_data[511:504] == 8'h00) else $error("Read data mismatch (expected 0x00 block)");

        // Phase 3: Write block 0 (reuse addr)
        #1000;
        write_enable = 1;
        #1000 write_enable = 0;  // Pulse or level; wait complete
        wait(write_complete == 1);
        $display("[%t] Write complete!", $time);
        assert (write_complete == 1) else $error("Write not complete");
        assert (error == 0) else $error("Write error");

        // End
        #2000;
        $display("=== sd_controller_tb PASSED ===");
        $finish;
    end

    // Dump
    initial begin
        $dumpfile("sd_controller_tb.vcd");
        $dumpvars(0, sd_controller_tb);
    end

endmodule