// sd_card_mock_tb.v
`timescale 1ns/1ps

module sd_card_mock_tb;

    reg clk;
    reg rst_n;
    reg spi_cs_n;
    reg spi_mosi;
    wire spi_miso;
    reg spi_clk;

    // DUTs
    spi_transactor spi_tx (
        .clk(clk),
        .rst_n(rst_n),
        .spi_clk_rising(spi_clk && !spi_clk_dly),
        .spi_clk_falling(!spi_clk && spi_clk_dly),
        .start(start),
        .tx_data(tx_data),
        .rx_data(rx_data),
        .done(done),
        .spi_mosi(spi_mosi),
        .spi_miso(spi_miso)
    );

    sd_card_mock sd_mock (
        .clk(clk),
        .rst_n(rst_n),
        .spi_cs_n(spi_cs_n),
        .spi_clk(spi_clk),
        .spi_mosi(spi_mosi),
        .spi_miso(spi_miso)
    );

    // SPI clock (6.25 MHz)
    always #80 spi_clk = ~spi_clk;

    reg spi_clk_dly;
    always @(posedge clk) spi_clk_dly <= spi_clk;

    // Test control
    reg start;
    reg [7:0] tx_data;
    wire [7:0] rx_data;
    wire done;

    integer error_cnt = 0;
    reg [7:0] expected;

    task send_cmd;
        input [5:0] cmd;
        input [31:0] arg;
        input [7:0] crc;
        integer i;
        begin
            $display("\n[%t] TB: Sending CMD%0d arg=0x%08h", $time, cmd, arg);
            spi_cs_n = 0;
            for (i = 0; i < 6; i = i + 1) begin
                case (i)
                    0: tx_data = {2'b01, cmd};
                    1: tx_data = arg[31:24];
                    2: tx_data = arg[23:16];
                    3: tx_data = arg[15:8];
                    4: tx_data = arg[7:0];
                    5: tx_data = crc;
                endcase
                start = 1; #20; start = 0;
                wait(done);
                #100;
            end
            // Wait for R1
            start = 1; tx_data = 8'hFF; #20; start = 0;
            wait(done);
            expected = (cmd == 0) ? 8'h01 : 8'h00;
            if (rx_data !== expected && cmd inside {0,8,55,41,58,16,17,24}) begin
                $error("R1 mismatch: exp 0x%02h, got 0x%02h", expected, rx_data);
                error_cnt = error_cnt + 1;
            end
            #100;
        end
    endtask

    task read_block;
        input [31:0] addr;
        integer i;
        reg [7:0] data;
        begin
            $display("[%t] TB: Reading block 0x%08h", $time, addr);
            send_cmd(17, addr, 8'h01);
            // Wait for data token
            do begin
                start = 1; tx_data = 8'hFF; #20; start = 0;
                wait(done);
            end while (rx_data !== 8'hFE);
            $display("[%t] TB: Data token received", $time);

            for (i = 0; i < 64; i = i + 1) begin
                start = 1; tx_data = 8'hFF; #20; start = 0;
                wait(done);
                data = (addr + i) ^ 8'hA5;
                if (rx_data !== data) begin
                    $error("Read data[%0d] mismatch: exp 0x%02h, got 0x%02h", i, data, rx_data);
                    error_cnt = error_cnt + 1;
                end
            end
            // CRC
            repeat (2) begin
                start = 1; tx_data = 8'hFF; #20; start = 0;
                wait(done);
            end
            spi_cs_n = 1;
            #500;
        end
    endtask

    initial begin
        clk = 0; spi_clk = 0; spi_clk_dly = 0;
        rst_n = 0; spi_cs_n = 1; start = 0;
        #100 rst_n = 1;

        // Power-up delay
        spi_cs_n = 1;
        repeat (80) begin
            start = 1; tx_data = 8'hFF; #20; start = 0;
            wait(done);
        end

        // === Initialization ===
        send_cmd(0,  32'h00000000, 8'h95);  // CMD0
        send_cmd(8,  32'h000001AA, 8'h87);  // CMD8
        send_cmd(59, 32'h00000000, 8'h01);  // CMD59 CRC OFF
        send_cmd(55, 32'h00000000, 8'h65);  // CMD55
        send_cmd(41, 32'h40000000, 8'h01);  // ACMD41 (HCS=1)
        repeat (10) begin
            send_cmd(55, 32'h00000000, 8'h65);
            send_cmd(41, 32'h40000000, 8'h01);
        end
        send_cmd(58, 32'h00000000, 8'hFF);  // CMD58
        send_cmd(16, 32'h00000040, 8'hFF);  // CMD16 block len 64

        // === Test Read/Write ===
        read_block(32'd0);
        // Write pattern
        spi_cs_n = 0;
        send_cmd(24, 32'd0, 8'h01);
        // Data token
        start = 1; tx_data = 8'hFE; #20; start = 0; wait(done);
        for (i = 0; i < 64; i = i + 1) begin
            tx_data = i[7:0] ^ 8'h5A;
            start = 1; #20; start = 0; wait(done);
        end
        // CRC
        repeat (2) begin
            start = 1; tx_data = 8'hFF; #20; start = 0; wait(done);
        end
        // Data response
        start = 1; tx_data = 8'hFF; #20; start = 0; wait(done);
        if (rx_data[4:0] !== 5'h05) $error("Write response error");
        // Busy
        repeat (50) begin
            start = 1; tx_data = 8'hFF; #20; start = 0; wait(done);
        end
        spi_cs_n = 1;

        read_block(32'd0);  // Verify write

        #1000;
        if (error_cnt == 0)
            $display("=== SD_CARD_MOCK_TB PASSED ===\n");
        else
            $display("=== SD_CARD_MOCK_TB FAILED (%0d errors) ===\n", error_cnt);
        $finish;
    end

    always #10 clk = ~clk;

endmodule